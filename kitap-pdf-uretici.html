<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <title>Vue PDF Template (Text + Drag & Drop Image)</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            display: flex;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #0f172a, #1e293b);
            overflow: hidden;
            color: #000000;
        }

        #app {
            display: flex;
            width: 100%;
            height: 100vh;
            gap: 20px;
        }

        /* A4 alanÄ± */
        #a4 {
            width: 210mm;
            height: 297mm;
            border: 2px dashed #8b5cf6;
            background-color: #ffffff;
            position: relative;
            flex-shrink: 0;
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.25);
            border-radius: 16px;
            transition: transform 0.3s ease;
        }

        #a4:hover {
            transform: scale(1.01);
        }

        /* Alan yerleÅŸtirme */
        .placed {
            position: absolute;
            border: 1px solid #22c55e;
            background: rgba(34, 197, 94, 0.1);
            font-size: 13px;
            cursor: move;
            border-radius: 6px;
            padding: 4px;
            transition: box-shadow 0.2s ease;
        }

        .placed:hover {
            box-shadow: 0 0 10px rgba(139, 92, 246, 0.6);
        }

        .a4-wrapper {
            flex-shrink: 0;
            /* EsnekliÄŸi kapat */
            max-height: 100vh;
            /* EkranÄ± aÅŸarsa */
            overflow-y: auto;
            /* Dikey scroll */
            padding-right: 10px;
            /* Scroll Ã§ubuÄŸu iÃ§in boÅŸluk */
        }

        .button-group {
            display: flex;
            gap: 10px;
            /* Butonlar arasÄ±ndaki boÅŸluk */
        }



        /* Kontrol paneli */
        .controls {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 15px;
            overflow-y: auto;
            max-height: 100vh;
            padding: 20px;
            background: rgba(178, 27, 243, 0.9);
            border-radius: 16px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.35);
        }

        h3,
        h4 {
            color: #e2e8f0;
            margin-bottom: 10px;
        }

        /* Butonlar */
        button {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            color: white;
            border: none;
            padding: 10px 14px;
            cursor: pointer;
            font-size: 14px;
            border-radius: 10px;
            transition: all 0.2s ease-in-out;
        }

        button:hover {
            transform: scale(1.05);
            background: linear-gradient(135deg, #7c3aed, #6d28d9);
        }

        button.active {
            background: #22c55e;
            box-shadow: 0 0 12px rgba(34, 197, 94, 0.6);
        }

        input[type="file"],
        input[type="text"],
        input[type="number"],
        select {
            margin-top: 6px;
            padding: 8px;
            width: 100%;
            border-radius: 8px;
            border: 1px solid #475569;
            background: #1e293b;
            color: #f8fafc;
        }

        /* Modal */
        .modal {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease forwards;
            z-index: 1000;
        }

        .modal-content {
            background: #f8fafc;
            color: #0f172a;
            padding: 24px;
            border-radius: 16px;
            max-width: 420px;
            width: 90%;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.25);
            animation: slideUp 0.3s ease forwards;
        }

        /* Animasyonlar */
        @keyframes fadeIn {
            from {
                opacity: 0
            }

            to {
                opacity: 1
            }
        }

        @keyframes slideUp {
            from {
                transform: translateY(20px);
                opacity: 0
            }

            to {
                transform: translateY(0);
                opacity: 1
            }
        }
    </style>

</head>

<body>
    <div class="a4-wrapper">

        <div id="app">
            <!-- Loading indicator -->
            <div v-if="loading" class="loading">
                PDF oluÅŸturuluyor... {{ loadingProgress }}%
            </div>

            <!-- Template kaydetme modalÄ± -->
            <div v-if="showSaveModal" class="modal">
                <div class="modal-content">
                    <h4>Template'i Kaydet</h4>
                    <p>Bu template'i kaydetmek ister misiniz?</p>
                    <label>Template AdÄ±:</label><br>
                    <input type="text" v-model="templateName" placeholder="Template adÄ±nÄ± girin"
                        style="width: 100%; margin: 10px 0;"><br>
                    <div class="modal-buttons">
                        <button @click="showSaveModal = false" style="background-color: #666;">Ä°ptal</button>
                        <button @click="saveTemplate" :disabled="!templateName.trim()">Kaydet</button>
                    </div>
                </div>
            </div>

            <!-- A4 sahnesi -->
            <div id="a4" @click="selected=null" @dragover.prevent @drop="onDrop">
                <div v-for="(item,i) in placed" :key="i" class="placed"
                    :style="{ left: item.x+'px', top: item.y+'px', width:item.width+'px', height:item.height+'px' }"
                    @mousedown.stop="startDrag(i,$event)" @dragstart.prevent draggable="false" @click.stop="selected=i">

                    <template v-if="item.type==='image'">
                        <img :src="item.src" :style="{width:'100%', height:'100%', objectFit: 'contain'}"
                            draggable="false" />
                    </template>
                    <template v-else-if="item.type==='url_image'">
                        <div
                            style="width:100%; height:100%; display:flex; align-items:center; justify-content:center; font-size:10px; text-align:center;">
                            URL Resim<br>{{ item.column || 'Excel kolonu belirtilmedi' }}
                        </div>
                    </template>
                    <template v-else>{{item.label}}</template>

                    <!-- Resize handles sadece resim tipli ve seÃ§ili alan iÃ§in -->
                    <template v-if="(item.type==='image' || item.type==='url_image') && selected===i">
                        <!-- KÃ¶ÅŸe handle'larÄ± -->
                        <div class="resize-handle resize-corner nw" @mousedown.stop="startResize(i, 'nw', $event)">
                        </div>
                        <div class="resize-handle resize-corner ne" @mousedown.stop="startResize(i, 'ne', $event)">
                        </div>
                        <div class="resize-handle resize-corner sw" @mousedown.stop="startResize(i, 'sw', $event)">
                        </div>
                        <div class="resize-handle resize-corner se" @mousedown.stop="startResize(i, 'se', $event)">
                        </div>

                        <!-- Kenar handle'larÄ± -->
                        <div class="resize-handle resize-edge n" @mousedown.stop="startResize(i, 'n', $event)"></div>
                        <div class="resize-handle resize-edge s" @mousedown.stop="startResize(i, 's', $event)"></div>
                        <div class="resize-handle resize-edge w" @mousedown.stop="startResize(i, 'w', $event)"></div>
                        <div class="resize-handle resize-edge e" @mousedown.stop="startResize(i, 'e', $event)"></div>
                    </template>
                </div>

            </div>

            <!-- Kontrol paneli saÄŸda -->
            <div class="controls">
                <h3>Template Editor</h3>

                <div class="button-group">
                    <button :class="{active: activeButton==='text'}" @click="addTextBlock">Text Ekle</button>
                    <button :class="{active: activeButton==='image'}" @click="addImageBlock">Resim Ekle</button>
                    <button :class="{active: activeButton==='url_image'}" @click="addUrlImageBlock">URL'den Resim
                        Ekle</button>
                </div>

                <button :class="{active: activeButton==='pdf'}" @click="exportPdfClick" :disabled="loading">PDF
                    Ãœret</button>

                <div v-if="selected!==null" class="editor">
                    <h4>Alan DÃ¼zenle - {{ placed[selected].type === 'text' ? 'Text' : placed[selected].type === 'image'
                        ?
                        'Resim' : 'URL Resim' }}</h4>

                    <label>Etiket:</label><br>
                    <input v-model="placed[selected].label" placeholder="Ã¶rn. MÃ¼ÅŸteri AdÄ±"><br><br>

                    <div v-if="placed[selected].type === 'url_image'">
                        <label>Excel Kolonu (URL):</label><br>
                        <input v-model="placed[selected].column" placeholder="Ã¶rn. ImageURL"><br><br>

                        <label>Test URL'i:</label><br>
                        <input v-model="testUrl" placeholder="Test iÃ§in bir URL girin"><br><br>
                        <button @click="testUrlImage">URL'yi Test Et</button><br><br>

                        <div v-if="urlTestResult" style="margin-top: 10px;">
                            <strong>Test Sonucu:</strong><br>
                            <span :style="{color: urlTestResult.success ? 'green' : 'red'}">
                                {{ urlTestResult.message }}
                            </span><br>
                            <img v-if="urlTestResult.success && urlTestResult.imageData" :src="urlTestResult.imageData"
                                style="max-width: 100px; max-height: 100px; margin-top: 5px;">
                        </div>
                    </div>
                    <div v-else>
                        <label>Excel Kolonu:</label><br>
                        <input v-model="placed[selected].column" placeholder="Ã¶rn. Name"><br><br>
                    </div>

                    <label>GeniÅŸlik (px):</label><br>
                    <input type="number" v-model.number="placed[selected].width"><br><br>
                    <label>YÃ¼kseklik (px):</label><br>
                    <input type="number" v-model.number="placed[selected].height"><br><br>

                    <div v-if="placed[selected].type==='image'">
                        <label>
                            <input type="checkbox" v-model="placed[selected].maintainAspectRatio">
                            En-boy oranÄ±nÄ± koru
                        </label><br><br>
                    </div>

                    <div class="button-group">
                        <button @click="selected=null">Kapat</button>
                        <button @click="deleteSelectedItem" style="background-color: #dc3545;">Sil</button>
                    </div>
                </div>

                <div class="editor">
                    <label>Excel DosyasÄ± SeÃ§:</label>
                    <input type="file" @change="onExcel" accept=".xlsx,.xls,.csv" />
                    <small>Resimler masaÃ¼stÃ¼nden sÃ¼rÃ¼kle-bÄ±rak ile A4 sahnesine eklenebilir.</small>
                    <div v-if="rows.length">
                        <br><strong>{{ rows.length }} satÄ±r yÃ¼klendi</strong>
                        <br>Kolonlar: {{ Object.keys(rows[0] || {}).join(', ') }}
                    </div>
                </div>

                <!-- KayÄ±tlÄ± Template'ler -->
                <div v-if="savedTemplates.length" class="editor">
                    <h4>KayÄ±tlÄ± Template'ler</h4>
                    <div class="saved-templates">
                        <div v-for="(template, index) in savedTemplates" :key="index" class="template-item">
                            <span class="template-name">{{ template.name }}</span>
                            <span class="template-date">{{ formatDate(template.date) }}</span>
                            <div>
                                <button @click="loadTemplate(template)"
                                    style="background-color: #28a745; font-size: 12px; padding: 4px 8px;">YÃ¼kle</button>
                                <button @click="deleteTemplate(index)"
                                    style="background-color: #dc3545; font-size: 12px; padding: 4px 8px; margin-left: 5px;">Sil</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>



    <script>
        const { jsPDF } = window.jspdf;

        Vue.createApp({
            data() {
                return {
                    placed: [],
                    rows: [],
                    selected: null,
                    dragging: { index: null, offsetX: 0, offsetY: 0 },
                    resizing: { index: null, direction: null, startX: 0, startY: 0, startWidth: 0, startHeight: 0, startLeft: 0, startTop: 0 },
                    activeButton: null,
                    loading: false,
                    loadingProgress: 0,
                    testUrl: '',
                    urlTestResult: null,
                    showSaveModal: false,
                    templateName: '',
                    savedTemplates: []
                }
            },
            mounted() {
                document.addEventListener("mousemove", this.onMouseMove);
                document.addEventListener("mouseup", this.onMouseUp);
                this.loadSavedTemplates();
            },
            methods: {
                addTextBlock() {
                    this.activeButton = 'text';
                    this.placed.push({
                        type: 'text',
                        label: 'Yeni Text AlanÄ±',
                        column: '',
                        x: 50,
                        y: 50,
                        width: 150,
                        height: 20
                    });
                    this.selected = this.placed.length - 1;
                    setTimeout(() => this.activeButton = null, 200);
                },

                addImageBlock() {
                    this.activeButton = 'image';
                    this.placed.push({
                        type: 'image',
                        label: 'Resim AlanÄ±',
                        column: '',
                        src: '',
                        x: 50,
                        y: 80,
                        width: 100,
                        height: 100,
                        maintainAspectRatio: true,
                        originalAspectRatio: 1
                    });
                    this.selected = this.placed.length - 1;
                    setTimeout(() => this.activeButton = null, 200);
                },

                addUrlImageBlock() {
                    this.activeButton = 'url_image';
                    this.placed.push({
                        type: 'url_image',
                        label: 'URL Resim',
                        column: '',
                        x: 50,
                        y: 110,
                        width: 100,
                        height: 100
                    });
                    this.selected = this.placed.length - 1;
                    setTimeout(() => this.activeButton = null, 200);
                },

                async testUrlImage() {
                    if (!this.testUrl) {
                        this.urlTestResult = { success: false, message: 'LÃ¼tfen test URL\'i girin!' };
                        return;
                    }

                    this.urlTestResult = { success: false, message: 'Test ediliyor...' };

                    try {
                        const imageData = await this.loadImageFromUrl(this.testUrl);
                        this.urlTestResult = {
                            success: true,
                            message: 'URL baÅŸarÄ±yla yÃ¼klendi!',
                            imageData: imageData
                        };
                    } catch (error) {
                        this.urlTestResult = {
                            success: false,
                            message: 'Hata: ' + error.message
                        };
                    }
                },

                deleteSelectedItem() {
                    if (this.selected !== null && confirm('Bu alanÄ± silmek istediÄŸinizden emin misiniz?')) {
                        this.placed.splice(this.selected, 1);
                        this.selected = null;
                    }
                },

                startDrag(index, e) {
                    this.dragging.index = index;
                    this.dragging.offsetX = e.offsetX;
                    this.dragging.offsetY = e.offsetY;
                },

                startResize(index, direction, e) {
                    this.resizing.index = index;
                    this.resizing.direction = direction;
                    this.resizing.startX = e.clientX;
                    this.resizing.startY = e.clientY;
                    this.resizing.startWidth = this.placed[index].width;
                    this.resizing.startHeight = this.placed[index].height;
                    this.resizing.startLeft = this.placed[index].x;
                    this.resizing.startTop = this.placed[index].y;
                },

                onMouseMove(e) {
                    if (this.dragging.index !== null) {
                        const rect = document.getElementById("a4").getBoundingClientRect();
                        const item = this.placed[this.dragging.index];
                        item.x = Math.min(Math.max(e.clientX - rect.left - this.dragging.offsetX, 0), rect.width - item.width);
                        item.y = Math.min(Math.max(e.clientY - rect.top - this.dragging.offsetY, 0), rect.height - item.height);
                    }

                    if (this.resizing.index !== null) {
                        const deltaX = e.clientX - this.resizing.startX;
                        const deltaY = e.clientY - this.resizing.startY;
                        const item = this.placed[this.resizing.index];
                        const direction = this.resizing.direction;

                        let newWidth = this.resizing.startWidth;
                        let newHeight = this.resizing.startHeight;
                        let newX = this.resizing.startLeft;
                        let newY = this.resizing.startTop;

                        if (direction === 'se') {
                            newWidth = Math.max(20, this.resizing.startWidth + deltaX);
                            newHeight = Math.max(20, this.resizing.startHeight + deltaY);
                        } else if (direction === 'sw') {
                            newWidth = Math.max(20, this.resizing.startWidth - deltaX);
                            newHeight = Math.max(20, this.resizing.startHeight + deltaY);
                            newX = this.resizing.startLeft + deltaX;
                        } else if (direction === 'ne') {
                            newWidth = Math.max(20, this.resizing.startWidth + deltaX);
                            newHeight = Math.max(20, this.resizing.startHeight - deltaY);
                            newY = this.resizing.startTop + deltaY;
                        } else if (direction === 'nw') {
                            newWidth = Math.max(20, this.resizing.startWidth - deltaX);
                            newHeight = Math.max(20, this.resizing.startHeight - deltaY);
                            newX = this.resizing.startLeft + deltaX;
                            newY = this.resizing.startTop + deltaY;
                        } else if (direction === 'n') {
                            newHeight = Math.max(20, this.resizing.startHeight - deltaY);
                            newY = this.resizing.startTop + deltaY;
                        } else if (direction === 's') {
                            newHeight = Math.max(20, this.resizing.startHeight + deltaY);
                        } else if (direction === 'w') {
                            newWidth = Math.max(20, this.resizing.startWidth - deltaX);
                            newX = this.resizing.startLeft + deltaX;
                        } else if (direction === 'e') {
                            newWidth = Math.max(20, this.resizing.startWidth + deltaX);
                        }

                        if (item.maintainAspectRatio && item.originalAspectRatio && ['se', 'sw', 'ne', 'nw'].includes(direction)) {
                            if (Math.abs(deltaX) > Math.abs(deltaY)) {
                                newHeight = newWidth / item.originalAspectRatio;
                            } else {
                                newWidth = newHeight * item.originalAspectRatio;
                            }

                            if (direction === 'sw' || direction === 'nw') {
                                newX = this.resizing.startLeft + (this.resizing.startWidth - newWidth);
                            }
                            if (direction === 'ne' || direction === 'nw') {
                                newY = this.resizing.startTop + (this.resizing.startHeight - newHeight);
                            }
                        }

                        const rect = document.getElementById("a4").getBoundingClientRect();
                        if (newX < 0) {
                            newWidth += newX;
                            newX = 0;
                        }
                        if (newY < 0) {
                            newHeight += newY;
                            newY = 0;
                        }
                        if (newX + newWidth > rect.width) {
                            newWidth = rect.width - newX;
                        }
                        if (newY + newHeight > rect.height) {
                            newHeight = rect.height - newY;
                        }

                        item.width = Math.max(20, Math.round(newWidth));
                        item.height = Math.max(20, Math.round(newHeight));
                        item.x = Math.round(newX);
                        item.y = Math.round(newY);
                    }
                },

                onMouseUp() {
                    this.dragging.index = null;
                    this.resizing.index = null;
                },

                onDrop(e) {
                    e.preventDefault();
                    const files = e.dataTransfer.files;

                    for (let i = 0; i < files.length; i++) {
                        const file = files[i];
                        if (file.type.startsWith("image/")) {
                            this.loadImageWithOriginalSize(file, e.offsetX, e.offsetY);
                        }
                    }
                },

                loadImageWithOriginalSize(file, x, y) {
                    const reader = new FileReader();
                    reader.onload = (ev) => {
                        const img = new Image();
                        img.onload = () => {
                            let width = img.naturalWidth;
                            let height = img.naturalHeight;

                            const maxSize = 400;
                            if (width > maxSize || height > maxSize) {
                                const ratio = Math.min(maxSize / width, maxSize / height);
                                width = width * ratio;
                                height = height * ratio;
                            }

                            this.placed.push({
                                type: 'image',
                                label: file.name,
                                column: '',
                                src: ev.target.result,
                                x: x,
                                y: y,
                                width: Math.round(width),
                                height: Math.round(height),
                                maintainAspectRatio: true,
                                originalAspectRatio: img.naturalWidth / img.naturalHeight
                            });
                        };
                        img.src = ev.target.result;
                    };
                    reader.readAsDataURL(file);
                },

                async loadImageFromUrl(url) {
                    return new Promise((resolve, reject) => {
                        const img = new Image();
                        img.crossOrigin = "anonymous";

                        img.onload = () => {
                            try {
                                const canvas = document.createElement('canvas');
                                const ctx = canvas.getContext('2d');
                                canvas.width = img.naturalWidth;
                                canvas.height = img.naturalHeight;
                                ctx.drawImage(img, 0, 0);
                                resolve(canvas.toDataURL('image/jpeg', 0.9));
                            } catch (error) {
                                reject(new Error('Canvas iÅŸlemi baÅŸarÄ±sÄ±z'));
                            }
                        };

                        img.onerror = () => {
                            this.tryProxyServices(url).then(resolve).catch(reject);
                        };

                        const cleanUrl = url.trim();
                        if (!cleanUrl.startsWith('http://') && !cleanUrl.startsWith('https://')) {
                            reject(new Error('GeÃ§ersiz URL formatÄ±. http:// veya https:// ile baÅŸlamalÄ±.'));
                            return;
                        }

                        img.src = cleanUrl;
                    });
                },

                async tryProxyServices(url) {
                    const proxyServices = [
                        `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(url)}`,
                        `https://cors-anywhere.herokuapp.com/${url}`,
                        `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`
                    ];

                    for (const proxyUrl of proxyServices) {
                        try {
                            const response = await fetch(proxyUrl);
                            if (response.ok) {
                                const blob = await response.blob();
                                return new Promise((resolve, reject) => {
                                    const reader = new FileReader();
                                    reader.onload = () => resolve(reader.result);
                                    reader.onerror = () => reject(new Error('Dosya okunamadÄ±'));
                                    reader.readAsDataURL(blob);
                                });
                            }
                        } catch (error) {
                            console.log(`Proxy ${proxyUrl} baÅŸarÄ±sÄ±z:`, error);
                            continue;
                        }
                    }

                    throw new Error('Resim yÃ¼klenemedi. CORS hatasÄ± veya geÃ§ersiz URL.');
                },

                async onExcel(e) {
                    const file = e.target.files[0];
                    if (!file) return;

                    try {
                        const buf = await file.arrayBuffer();
                        const wb = XLSX.read(buf, { type: "array" });
                        const ws = wb.Sheets[wb.SheetNames[0]];
                        this.rows = XLSX.utils.sheet_to_json(ws, { defval: "" });
                        alert(this.rows.length + " satÄ±r okundu!");
                    } catch (error) {
                        alert("Excel dosyasÄ± okunamadÄ±: " + error.message);
                    }
                },

                exportPdfClick() {
                    this.activeButton = 'pdf';
                    this.exportPdf();
                    setTimeout(() => this.activeButton = null, 200);
                },

                async exportPdf() {
                    if (!this.rows.length) {
                        alert("Ã–nce excel seÃ§in!");
                        return;
                    }

                    this.loading = true;
                    this.loadingProgress = 0;

                    try {
                        // ðŸ‘‡ px ile birebir Ã§alÄ±ÅŸan PDF
                        const doc = new jsPDF({
                            unit: "px",
                            format: [794, 1123] // A4 px boyutu
                        });
                        for (let rowIndex = 0; rowIndex < this.rows.length; rowIndex++) {
                            const row = this.rows[rowIndex];
                            this.loadingProgress = Math.round(((rowIndex + 1) / this.rows.length) * 100);

                            if (rowIndex > 0) {
                                doc.addPage();
                            }

                            for (const field of this.placed) {
                                try {
                                    if (field.type === 'image' && field.src) {
                                        doc.addImage(field.src, "JPEG", field.x, field.y, field.width, field.height);
                                    } else if (field.type === 'url_image' && field.column) {
                                        const imageUrl = row[field.column];
                                        if (imageUrl) {
                                            try {
                                                const imgData = await this.loadImageFromUrl(imageUrl);
                                                doc.addImage(imgData, "JPEG", field.x, field.y, field.width, field.height);
                                            } catch (error) {
                                                console.warn('Resim yÃ¼klenemedi:', imageUrl, error);
                                                doc.text(`Resim yÃ¼klenemedi: ${imageUrl}`, field.x, field.y + 12);
                                            }
                                        }
                                    } else {
                                        const val = row[field.column] || "";
                                        const text = field.label ? `${field.label}: ${val}` : val.toString();
                                        doc.text(text, field.x, field.y + 12); // ðŸ‘ˆ px uyumlu
                                    }
                                } catch (error) {
                                    console.warn('Alan iÅŸlenirken hata:', field, error);
                                }
                            }

                            if (rowIndex % 10 === 0) {
                                await new Promise(resolve => setTimeout(resolve, 10));
                            }
                        }

                        doc.save("output.pdf");

                        // PDF baÅŸarÄ±yla oluÅŸturulduktan sonra kaydetme modalÄ±nÄ± gÃ¶ster
                        this.showSaveModal = true;
                        this.templateName = '';

                    } catch (error) {
                        alert("PDF oluÅŸturulurken hata: " + error.message);
                    } finally {
                        this.loading = false;
                        this.loadingProgress = 0;
                    }
                },


                saveTemplate() {
                    if (!this.templateName.trim()) return;

                    const template = {
                        name: this.templateName.trim(),
                        date: new Date().toISOString(),
                        placed: JSON.parse(JSON.stringify(this.placed)) // Deep copy
                    };

                    this.savedTemplates.push(template);
                    localStorage.setItem('pdfTemplates', JSON.stringify(this.savedTemplates));

                    this.showSaveModal = false;
                    this.templateName = '';
                    alert('Template baÅŸarÄ±yla kaydedildi!');
                },

                loadTemplate(template) {
                    if (confirm(`"${template.name}" template'ini yÃ¼klemek istediÄŸinizden emin misiniz? Mevcut Ã§alÄ±ÅŸma kaybolacak.`)) {
                        this.placed = JSON.parse(JSON.stringify(template.placed)); // Deep copy
                        this.selected = null;
                        alert('Template yÃ¼klendi!');
                    }
                },

                deleteTemplate(index) {
                    if (confirm('Bu template\'i silmek istediÄŸinizden emin misiniz?')) {
                        this.savedTemplates.splice(index, 1);
                        localStorage.setItem('pdfTemplates', JSON.stringify(this.savedTemplates));
                        alert('Template silindi!');
                    }
                },

                loadSavedTemplates() {
                    const saved = localStorage.getItem('pdfTemplates');
                    if (saved) {
                        try {
                            this.savedTemplates = JSON.parse(saved);
                        } catch (error) {
                            console.warn('KayÄ±tlÄ± template\'ler yÃ¼klenemedi:', error);
                            this.savedTemplates = [];
                        }
                    }
                },

                formatDate(isoString) {
                    const date = new Date(isoString);
                    return date.toLocaleDateString('tr-TR') + ' ' + date.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' });
                }
            },

            watch: {
                'placed': {
                    handler(newPlaced) {
                        newPlaced.forEach(item => {
                            if (item.type === 'image' && item.maintainAspectRatio && item.originalAspectRatio) {
                                if (item.width && item.width !== item.lastWidth) {
                                    item.height = Math.round(item.width / item.originalAspectRatio);
                                    item.lastWidth = item.width;
                                }
                                else if (item.height && item.height !== item.lastHeight) {
                                    item.width = Math.round(item.height * item.originalAspectRatio);
                                    item.lastHeight = item.height;
                                }
                            }
                        });
                    },
                    deep: true
                }
            }
        }).mount("#app");
    </script>
</body>

</html>